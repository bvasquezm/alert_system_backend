name: Daily Scraper and Teams Report

on:
  schedule:
    # RUNS AT 08:00 UTC-3: Santiago de Chile (11:00 UTC)
    - cron: '0 11 * * *'
  workflow_dispatch:

jobs:
  run-scrape-and-report:
    runs-on: ubuntu-latest
    env:
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
    steps:
      - name: Validate configuration
        run: |
          if [ -z "${API_BASE_URL}" ]; then
            echo "API_BASE_URL is not set. Configure it in Repo Settings > Secrets and variables > Actions."
            exit 1
          fi
          echo "Using API_BASE_URL=${API_BASE_URL}"

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Trigger scrape
        run: |
          set -euo pipefail
          echo "Triggering scrape..."
          RESP=$(curl -sS -X POST "${API_BASE_URL}/api/scrape" -H "Content-Type: application/json" -w "\n%{http_code}")
          BODY=$(echo "$RESP" | sed '$d')
          CODE=$(echo "$RESP" | tail -n1)
          echo "HTTP $CODE"
          echo "Body: $BODY"
          if [ "$CODE" -ne 202 ] && [ "$CODE" -ne 409 ]; then
            echo "Failed to trigger scrape"
            exit 1
          fi

      - name: Wait for scrape completion
        run: |
          set -euo pipefail
          attempt=0
          max_attempts=40   # ~10 minutes with 15s sleep
          sleep_seconds=15
          while [ $attempt -lt $max_attempts ]; do
            STATUS_JSON=$(curl -sS "${API_BASE_URL}/api/scrape/status")
            echo "Status: $STATUS_JSON"
            IS_RUNNING=$(echo "$STATUS_JSON" | jq -r '.is_running // .isRunning // empty')
            ERROR_MSG=$(echo "$STATUS_JSON" | jq -r '.error // empty')

            if [ "$IS_RUNNING" = "false" ] || [ "$IS_RUNNING" = "0" ] || [ -z "$IS_RUNNING" ]; then
              if [ -n "$ERROR_MSG" ] && [ "$ERROR_MSG" != "null" ]; then
                echo "Scrape finished with error: $ERROR_MSG"
                exit 1
              fi
              echo "Scrape finished successfully."
              break
            fi

            attempt=$((attempt+1))
            echo "Still running... attempt $attempt/$max_attempts; sleeping ${sleep_seconds}s"
            sleep $sleep_seconds
          done

          if [ $attempt -ge $max_attempts ]; then
            echo "Timeout waiting for scrape to finish."
            exit 1
          fi

      - name: Send Teams report
        run: |
          set -euo pipefail
          echo "Sending Teams report..."
          RESP=$(curl -sS -X POST "${API_BASE_URL}/api/teams/report" -H "Content-Type: application/json" -w "\n%{http_code}")
          BODY=$(echo "$RESP" | sed '$d')
          CODE=$(echo "$RESP" | tail -n1)
          echo "HTTP $CODE"
          echo "Body: $BODY"
          if [ "$CODE" -ne 200 ]; then
            echo "Teams report failed."
            exit 1
          fi
