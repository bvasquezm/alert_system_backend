name: Daily Scraper and Teams Report

on:
  schedule:
    # RUNS AT 08:00 UTC-3: Santiago de Chile (11:00 UTC)
    - cron: '0 11 * * *'
  workflow_dispatch:

joconcurrency:
  group: daily-scrape-cli
  cancel-in-progress: false

jobs:
  run-scrape-cli:
    runs-on: ubuntu-latest
    env:
      MONGO_URI: ${{ secrets.MONGO_URI }}
      TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
      SCRAPER_CONFIG_PATH: ia/alert_system/backend/config_components.json
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: ia/alert_system/backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers + deps
        run: |
          python -m playwright install --with-deps

      - name: Run scraper synchronously and send Teams report
        working-directory: ia/alert_system/backend
        run: |
          python run_scrape_and_report.py

      - name: Verify latest report via API
        run: |
          set -euo pipefail
          if [ -z "${API_BASE_URL}" ]; then
            echo "API_BASE_URL is not set. Configure it as a repository secret."
            exit 1
          fi
          echo "Verifying latest report from ${API_BASE_URL}/api/report"
          RESP=$(curl -sS -L "${API_BASE_URL}/api/report" -w "\n%{http_code}")
          BODY=$(echo "$RESP" | sed '$d')
          CODE=$(echo "$RESP" | tail -n1)
          echo "HTTP $CODE"
          if [ "$CODE" -ne 200 ]; then
            echo "No report available (HTTP $CODE)"
            echo "$BODY"
            exit 1
          fi
          END_TIME=$(echo "$BODY" | jq -r '.end_time // empty')
          if [ -z "$END_TIME" ]; then
            echo "end_time not present in report payload"
            echo "$BODY"
            exit 1
          fi
          END_EPOCH=$(date -d "$END_TIME" +%s)
          NOW_EPOCH=$(date +%s)
          DIFF=$((NOW_EPOCH - END_EPOCH))
          # Accept reports generated within the last 45 minutes
          if [ $DIFF -gt 2700 ]; then
            echo "Latest report is older than 45 minutes (diff=${DIFF}s)"
            exit 1
          fi
          echo "Report is recent (diff=${DIFF}s). Verification OK."

      - name: Send Teams report via API
        run: |
          set -euo pipefail
          echo "Triggering Teams report via API..."
          RESP=$(curl -sS -L -X POST "${API_BASE_URL}/api/teams/report" -H "Content-Type: application/json" -w "\n%{http_code}")
          BODY=$(echo "$RESP" | sed '$d')
          CODE=$(echo "$RESP" | tail -n1)
          echo "HTTP $CODE"
          echo "Body: $BODY"
          if [ "$CODE" -ne 200 ]; then
            echo "Teams report API call failed"
            exit 1
          fi
